<?php

/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
defined('InShopNC') or exit('Access Invalid!');
class decorationControl extends SystemControl{
    
   private $links = array(
		array('url'=>'act=decoration&op=settings_index','lang'=>'category_manage'),
		array('url'=>'act=decoration&op=style_index','lang'=>'style_manage'),

	);
    
    public function __construct(){
		parent::__construct();	
                Language::read('decoration');

    }
    
    
    public function indexOp() {
//         $model_decoration = Model('decoration');
//        $work_list = $model_decoration->getWorkCommonList();
//        
//        $a=wthumb($work_list[0],60);
//        var_dump($a);
//        exit();
//       
//        $list_setting = $model_setting->getListSetting();
//        if ($list_setting['decoration_category'] != ''){
//			$list = mb_unserialize($list_setting['decoration_category']);
//	}
//        var_dump($list_setting['decoration_category']);   
//        exit();
//        $dc=array('家装','工装');
//        $sdc=serialize($dc);
//        $sdc=base64_encode($sdc);
//        var_dump($sdc);
//        //var_dump(unserialize($sdc));
//       // $str = 'a:9:{s:4:"time";i:1405306402;s:4:"name";s:6:"新晨";s:5:"url";s:1:"-";s:4:"word";s:1:"-";s:5:"rpage";s:29:"http://www.baidu.com/test.html";s:5:"cpage";s:1:"-";s:2:"ip";s:15:"117.151.180.150";s:7:"ip_city";s:31:"中国北京市 北京市移动";s:4:"miao";s:1:"5";}';  
//        var_dump(unserialize(base64_decode($sdc)));
    }
    
    public function settings_indexOp() {
          $model_decoration = Model('decoration');
          
          
//          var_dump($category);
//          exit();
          
         if (chksubmit()){
             $uparr=array_filter($_POST['category']);
             if($_POST['check_gc_id']){
                $uparr = array_diff($uparr,$_POST['check_gc_id']);
             }
             $cats=array_map("base64_encode",$uparr);
             $model_decoration->update_category($cats);
         }
         $category=$model_decoration->get_category();
          Tpl::output('category',$category);
          Tpl::output('top_link',$this->sublink($this->links,'settings_index'));
          Tpl::showpage('decoration.category');
          
          
    }
    
        public function style_indexOp() {
          $model_decoration = Model('decoration');
          
          
//          var_dump($category);
//          exit();
          
         if (chksubmit()){
             $uparr=array_filter($_POST['style']);
             if($_POST['check_gc_id']){
                $uparr = array_diff($uparr,$_POST['check_gc_id']);
             }
             $cats=array_map("base64_encode",$uparr);
             $model_decoration->update_style($cats);
         }
         $style=$model_decoration->get_style();
          Tpl::output('style',$style);
          Tpl::output('top_link',$this->sublink($this->links,'style_index'));
          Tpl::showpage('decoration.style');
          
          
    }
    
     public function worksOp() {
        $model_decoration = Model ( 'decoration' );
        /**
         * 处理分类风格
         */
        
        $style_arr = Model('decoration')->get_style();
        $category_arr = Model('decoration')->get_category();
	Tpl::output('style',$style_arr);
	Tpl::output('category',$category_arr);

        /**
         * 查询条件
         */
        $where = array();
        if ($_GET['search_goods_name'] != '') {
            $where['goods_name'] = array('like', '%' . trim($_GET['search_goods_name']) . '%');
        }
        if (intval($_GET['search_commonid']) > 0) {
            $where['goods_commonid'] = intval($_GET['search_commonid']);
        }
        if ($_GET['search_store_name'] != '') {
            $where['store_name'] = array('like', '%' . trim($_GET['search_store_name']) . '%');
        }
        if (intval($_GET['b_id']) > 0) {
            $where['brand_id'] = intval($_GET['b_id']);
        }
        if ($choose_gcid > 0){
		    $where['gc_id_'.($gccache_arr['showclass'][$choose_gcid]['depth'])] = $choose_gcid;
		}
        if (in_array($_GET['search_state'], array('0','1','10'))) {
            $where['goods_state'] = $_GET['search_state'];
        }
        if (in_array($_GET['search_verify'], array('0','1','10'))) {
            $where['goods_verify'] = $_GET['search_verify'];
        }

        switch ($_GET['type']) {
            // 禁售
            case 'lockup':
                $goods_list = $model_goods->getGoodsCommonLockUpList($where);
                break;
            // 等待审核
            case 'waitverify':
                $goods_list = $model_goods->getGoodsCommonWaitVerifyList($where, '*', 10, 'goods_verify desc, goods_commonid desc');
                break;
            // 全部商品
            default:
                $work_list = $model_decoration->getWorkCommonList($where);
                break;
        }
        Tpl::output('work_list', $work_list);
        Tpl::output('page', $model_decoration->showpage(2));

     //   $storage_array = $model_decoration->calculateStorage($goods_list);
      //  Tpl::output('storage_array', $storage_array);

        // 品牌
        //$brand_list = Model('brand')->getBrandPassedList(array());

        Tpl::output('search', $_GET);
        Tpl::output('brand_list', $brand_list);

        Tpl::output('state', array('1' => '竞标中', '0' => '审核中', '10' => '违规下架'));

        Tpl::output('verify', array('1' => '通过', '0' => '未通过', '10' => '等待审核'));

        //Tpl::output('ownShopIds', array_fill_keys(Model('store')->getOwnShopIds(), true));

        switch ($_GET['type']) {
            // 禁售
            case 'lockup':
                Tpl::showpage('goods.close');
                break;
            // 等待审核
            case 'waitverify':
                Tpl::showpage('goods.verify');
                break;
            // 全部商品
            default:
                Tpl::showpage('decoration.works.index');
                break;
        }
    }
    
     /**
     * 违规下架
     */
    
    public function work_lockupOp() {
       
        if (chksubmit()) {
            $commonids = $_POST['commonids'];
            $commonid_array = explode(',', $commonids);
            foreach ($commonid_array as $value) {
                if (!is_numeric($value)) {
                    showDialog(L('nc_common_op_fail'), 'reload');
                }
            }
            $update = array();
            $update['goods_stateremark'] = trim($_POST['close_reason']);

            $where = array();
            $where['goods_commonid'] = array('in', $commonid_array);

            Model('goods')->editProducesLockUp($update, $where);
            showDialog(L('nc_common_op_succ'), 'reload', 'succ');
        }
        Tpl::output('commonids', $_GET['id']);
        Tpl::showpage('decoration.close_remark', 'null_layout');
    
    }
    
    
    
}
