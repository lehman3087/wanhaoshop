<?php
/**
 * cms首页
 *
 *
 *
 * by 33hao.com 好商城V3 运营版
 */

//use Shopnc\Tpl;

defined('InShopNC') or exit('Access Invalid!');
class indexControl extends mobileHomeControl{

    public function __construct() {
        parent::__construct();
    }

    /**
     * 首页
     */
	public function indexOp() {
        $model_mb_special = Model('mb_special'); 
        $data = $model_mb_special->getMbSpecialIndex();
        $this->_output_special($data, $_GET['type']);
	}
        
        public function getGlobalOp() {
            $model_decoration_style=  Model('decoration');
            $styles=$model_decoration_style->get_style();
            $model_decoration = Model('decoration');
             $category=$model_decoration->get_category();
             $style=$model_decoration->get_style();
             
             //广告位
            $model = model('rec_position');
            $condition['rec_app'] = 1;
            $condition['rec_state'] = 1;
            $condition['rec_start_time'] =array('lt',time());
            $condition['rec_stop_time'] =array('gt',time());
            
            
            $rec_list = $model->where($condition)->order('rec_id desc')->select();
            
            foreach ($rec_list as $key => $value) {
                $appplys_model = model('rec_applys');
                $condition_arr['adp_id'] = $value['rec_id'];
                $condition_arr['adp_apply_state_in'] = "1";
                $applys=$appplys_model->getActivitiesJoinList($condition_arr);
                $rec_list[$key]['adp']=$applys;
            }
            
             //平台活动
             $activity	= Model('activity');
             $act_condition['opening']=true;
             $act_list= $activity->getJoinList($act_condition,$page);
            
             //
            $global=array(
                'snsTracePath'=>'/shop/index.php?act=show_store&op=show_share&store_id=1&strace_id=',
                'decoration_style'=>$styles,
                'designer_head'=>'',
                'category'=>$category,
                'style'=>$style,
                'decoration_work_path'=>'/shop/store/work/',//案例图片地址
                'decoration_request_path'=>'/shop/member/request/',//后跟会员ID
                'rec_list'=>$rec_list,//广告位
                'act_list'=>$act_list,
                
            );
             output_data($global);        
        }

    /**
     * 专题
     */
    public function specialOp() {
        $model_mb_special = Model('mb_special'); 
        $data = $model_mb_special->getMbSpecialItemUsableListByID($_GET['special_id']);
        $this->_output_special($data, $_GET['type'], $_GET['special_id']);
    }

    /**
     * 输出专题
     */
    private function _output_special($data, $type = 'json', $special_id = 0) {
        $model_special = Model('mb_special');
        if($_GET['type'] == 'html') {
            $html_path = $model_special->getMbSpecialHtmlPath($special_id);
            if(!is_file($html_path)) {
                ob_start();
                Tpl::output('list', $data);
                Tpl::showpage('mb_special');
                file_put_contents($html_path, ob_get_clean());
            }
            header('Location: ' . $model_special->getMbSpecialHtmlUrl($special_id));
            die;
        } else {
            output_data($data);
        }
    }

    /**
     * android客户端版本号
     */
    public function apk_versionOp() {
		$version = C('mobile_apk_version');
		$url = C('mobile_apk');
        if(empty($version)) {
           $version = '';
        }
        if(empty($url)) {
            $url = '';
        }

        output_data(array('version' => $version, 'url' => $url));
    }
}
